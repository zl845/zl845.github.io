System.register("chunks:///_virtual/builtin-pipeline-settings.ts",["./rollupPluginModLoBabelHelpers.js","cc","./builtin-pipeline-types.ts"],(function(t){var e,o,i,n,r,s,a,p,l,g,c,y,u,d,b,m,h,f,_;return{setters:[function(t){e=t.applyDecoratedDescriptor,o=t.inherits,i=t.createSuper,n=t.classCallCheck,r=t.initializerDefineProperty,s=t.assertThisInitialized,a=t.createClass},function(t){p=t.cclegacy,l=t._decorator,g=t.Camera,c=t.CCBoolean,y=t.CCInteger,u=t.CCFloat,d=t.Material,b=t.Texture2D,m=t.rendering,h=t.Component},function(t){f=t.fillRequiredPipelineSettings,_=t.makePipelineSettings}],execute:function(){var P,M,S,O,w,k,E,G,C,D,v,A,j,x,F,B,R,I,T,L,X,z,H,q,Y,N,Q,Z;p._RF.push({},"de1c2EHcMhAIYRZY5nyTQHG","builtin-pipeline-settings",void 0);var J=l.ccclass,K=l.disallowMultiple,U=l.executeInEditMode,V=l.menu,W=l.property,$=l.requireComponent;l.type,t("BuiltinPipelineSettings",(P=J("BuiltinPipelineSettings"),M=V("Rendering/BuiltinPipelineSettings"),S=$(g),O=W(c),w=W({displayName:"Editor Preview (Experimental)",type:c}),k=W({group:{id:"MSAA",name:"Multisample Anti-Aliasing"},type:c}),E=W({group:{id:"MSAA",name:"Multisample Anti-Aliasing",style:"section"},type:y,range:[2,4,2]}),G=W({group:{id:"ShadingScale",name:"ShadingScale",style:"section"},type:c}),C=W({tooltip:"i18n:postprocess.shadingScale",group:{id:"ShadingScale",name:"ShadingScale"},type:u,range:[.01,4,.01],slide:!0}),D=W({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:c}),v=W({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:d}),A=W({tooltip:"i18n:bloom.enableAlphaMask",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:c}),j=W({tooltip:"i18n:bloom.iterations",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:y,range:[1,6,1],slide:!0}),x=W({tooltip:"i18n:bloom.threshold",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:u,min:0}),F=W({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:c}),B=W({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:d}),R=W({tooltip:"i18n:color_grading.contribute",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:u,range:[0,1,.01],slide:!0}),I=W({tooltip:"i18n:color_grading.originalMap",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:b}),T=W({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:c}),L=W({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:d}),X=W({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:c}),z=W({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:d}),H=W({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:u,range:[0,1,.01],slide:!0}),q=W({group:{id:"ToneMapping",name:"ToneMapping",style:"section"},type:d}),P(Y=M(Y=S(Y=K(Y=U((Q=e((N=function(t){o(p,t);var e=i(p);function p(){var t;n(this,p);for(var o=arguments.length,i=new Array(o),a=0;a<o;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i)),r(s(t),"_settings",Q,s(t)),r(s(t),"_editorPreview",Z,s(t)),t}return a(p,[{key:"getPipelineSettings",value:function(){return this._settings}},{key:"onEnable",value:function(){f(this._settings),this.getComponent(g).camera.pipelineSettings=this._settings}},{key:"onDisable",value:function(){this.getComponent(g).camera.pipelineSettings=null}},{key:"editorPreview",get:function(){return this._editorPreview},set:function(t){this._editorPreview=t}},{key:"_tryEnableEditorPreview",value:function(){void 0!==m&&(this._editorPreview?m.setEditorPipelineSettings(this._settings):this._disableEditorPreview())}},{key:"_disableEditorPreview",value:function(){void 0!==m&&(m.getEditorPipelineSettings()===this._settings&&m.setEditorPipelineSettings(null))}},{key:"MsaaEnable",get:function(){return this._settings.msaa.enabled},set:function(t){this._settings.msaa.enabled=t}},{key:"msaaSampleCount",get:function(){return this._settings.msaa.sampleCount},set:function(t){t=Math.pow(2,Math.ceil(Math.log2(Math.max(t,2)))),t=Math.min(t,4),this._settings.msaa.sampleCount=t}},{key:"shadingScaleEnable",get:function(){return this._settings.enableShadingScale},set:function(t){this._settings.enableShadingScale=t}},{key:"shadingScale",get:function(){return this._settings.shadingScale},set:function(t){this._settings.shadingScale=t}},{key:"bloomEnable",get:function(){return this._settings.bloom.enabled},set:function(t){this._settings.bloom.enabled=t}},{key:"bloomMaterial",get:function(){return this._settings.bloom.material},set:function(t){this._settings.bloom.material!==t&&(this._settings.bloom.material=t)}},{key:"bloomEnableAlphaMask",get:function(){return this._settings.bloom.enableAlphaMask},set:function(t){this._settings.bloom.enableAlphaMask=t}},{key:"bloomIterations",get:function(){return this._settings.bloom.iterations},set:function(t){this._settings.bloom.iterations=t}},{key:"bloomThreshold",get:function(){return this._settings.bloom.threshold},set:function(t){this._settings.bloom.threshold=t}},{key:"bloomIntensity",get:function(){return this._settings.bloom.intensity},set:function(t){this._settings.bloom.intensity=t}},{key:"colorGradingEnable",get:function(){return this._settings.colorGrading.enabled},set:function(t){this._settings.colorGrading.enabled=t}},{key:"colorGradingMaterial",get:function(){return this._settings.colorGrading.material},set:function(t){this._settings.colorGrading.material!==t&&(this._settings.colorGrading.material=t)}},{key:"colorGradingContribute",get:function(){return this._settings.colorGrading.contribute},set:function(t){this._settings.colorGrading.contribute=t}},{key:"colorGradingMap",get:function(){return this._settings.colorGrading.colorGradingMap},set:function(t){this._settings.colorGrading.colorGradingMap=t}},{key:"fxaaEnable",get:function(){return this._settings.fxaa.enabled},set:function(t){this._settings.fxaa.enabled=t}},{key:"fxaaMaterial",get:function(){return this._settings.fxaa.material},set:function(t){this._settings.fxaa.material!==t&&(this._settings.fxaa.material=t)}},{key:"fsrEnable",get:function(){return this._settings.fsr.enabled},set:function(t){this._settings.fsr.enabled=t}},{key:"fsrMaterial",get:function(){return this._settings.fsr.material},set:function(t){this._settings.fsr.material!==t&&(this._settings.fsr.material=t)}},{key:"fsrSharpness",get:function(){return this._settings.fsr.sharpness},set:function(t){this._settings.fsr.sharpness=t}},{key:"toneMappingMaterial",get:function(){return this._settings.toneMapping.material},set:function(t){this._settings.toneMapping.material!==t&&(this._settings.toneMapping.material=t)}}]),p}(h)).prototype,"_settings",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _()}}),Z=e(N.prototype,"_editorPreview",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e(N.prototype,"editorPreview",[w],Object.getOwnPropertyDescriptor(N.prototype,"editorPreview"),N.prototype),e(N.prototype,"MsaaEnable",[k],Object.getOwnPropertyDescriptor(N.prototype,"MsaaEnable"),N.prototype),e(N.prototype,"msaaSampleCount",[E],Object.getOwnPropertyDescriptor(N.prototype,"msaaSampleCount"),N.prototype),e(N.prototype,"shadingScaleEnable",[G],Object.getOwnPropertyDescriptor(N.prototype,"shadingScaleEnable"),N.prototype),e(N.prototype,"shadingScale",[C],Object.getOwnPropertyDescriptor(N.prototype,"shadingScale"),N.prototype),e(N.prototype,"bloomEnable",[D],Object.getOwnPropertyDescriptor(N.prototype,"bloomEnable"),N.prototype),e(N.prototype,"bloomMaterial",[v],Object.getOwnPropertyDescriptor(N.prototype,"bloomMaterial"),N.prototype),e(N.prototype,"bloomEnableAlphaMask",[A],Object.getOwnPropertyDescriptor(N.prototype,"bloomEnableAlphaMask"),N.prototype),e(N.prototype,"bloomIterations",[j],Object.getOwnPropertyDescriptor(N.prototype,"bloomIterations"),N.prototype),e(N.prototype,"bloomThreshold",[x],Object.getOwnPropertyDescriptor(N.prototype,"bloomThreshold"),N.prototype),e(N.prototype,"colorGradingEnable",[F],Object.getOwnPropertyDescriptor(N.prototype,"colorGradingEnable"),N.prototype),e(N.prototype,"colorGradingMaterial",[B],Object.getOwnPropertyDescriptor(N.prototype,"colorGradingMaterial"),N.prototype),e(N.prototype,"colorGradingContribute",[R],Object.getOwnPropertyDescriptor(N.prototype,"colorGradingContribute"),N.prototype),e(N.prototype,"colorGradingMap",[I],Object.getOwnPropertyDescriptor(N.prototype,"colorGradingMap"),N.prototype),e(N.prototype,"fxaaEnable",[T],Object.getOwnPropertyDescriptor(N.prototype,"fxaaEnable"),N.prototype),e(N.prototype,"fxaaMaterial",[L],Object.getOwnPropertyDescriptor(N.prototype,"fxaaMaterial"),N.prototype),e(N.prototype,"fsrEnable",[X],Object.getOwnPropertyDescriptor(N.prototype,"fsrEnable"),N.prototype),e(N.prototype,"fsrMaterial",[z],Object.getOwnPropertyDescriptor(N.prototype,"fsrMaterial"),N.prototype),e(N.prototype,"fsrSharpness",[H],Object.getOwnPropertyDescriptor(N.prototype,"fsrSharpness"),N.prototype),e(N.prototype,"toneMappingMaterial",[q],Object.getOwnPropertyDescriptor(N.prototype,"toneMappingMaterial"),N.prototype),Y=N))||Y)||Y)||Y)||Y)||Y));p._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline-types.ts",["cc"],(function(e){var a,n;return{setters:[function(e){a=e.cclegacy,n=e.gfx}],execute:function(){e({fillRequiredBloom:o,fillRequiredColorGrading:u,fillRequiredFSR:c,fillRequiredFXAA:m,fillRequiredHBAO:function(e){void 0===e.enabled&&(e.enabled=!1);void 0===e.radiusScale&&(e.radiusScale=1);void 0===e.angleBiasDegree&&(e.angleBiasDegree=10);void 0===e.blurSharpness&&(e.blurSharpness=3);void 0===e.aoSaturation&&(e.aoSaturation=1);void 0===e.needBlur&&(e.needBlur=!1)},fillRequiredMSAA:r,fillRequiredPipelineSettings:function(e){e.msaa?r(e.msaa):e.msaa=i();void 0===e.enableShadingScale&&(e.enableShadingScale=!1);void 0===e.shadingScale&&(e.shadingScale=.5);e.bloom?o(e.bloom):e.bloom={enabled:!1,material:null,enableAlphaMask:!1,iterations:3,threshold:.8,intensity:2.3};e.toneMapping?f(e.toneMapping):e.toneMapping={material:null};e.colorGrading?u(e.colorGrading):e.colorGrading={enabled:!1,material:null,contribute:1,colorGradingMap:null};e.fsr?c(e.fsr):e.fsr={enabled:!1,material:null,sharpness:.8};e.fxaa?m(e.fxaa):e.fxaa={enabled:!1,material:null}},fillRequiredToneMapping:f,makeBloom:t,makeColorGrading:d,makeFSR:s,makeFXAA:b,makeHBAO:function(){return{enabled:!1,radiusScale:1,angleBiasDegree:10,blurSharpness:3,aoSaturation:1,needBlur:!1}},makeMSAA:i,makePipelineSettings:function(){return{msaa:i(),enableShadingScale:!1,shadingScale:.5,bloom:{enabled:!1,material:null,enableAlphaMask:!1,iterations:3,threshold:.8,intensity:2.3},toneMapping:{material:null},colorGrading:{enabled:!1,material:null,contribute:1,colorGradingMap:null},fsr:{enabled:!1,material:null,sharpness:.8},fxaa:{enabled:!1,material:null}}},makeToneMapping:p}),a._RF.push({},"cbf30kCUX9A3K+QpVC6wnzx","builtin-pipeline-types",void 0);var l=n.SampleCount;function i(){return{enabled:!1,sampleCount:l.X4}}function r(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.sampleCount&&(e.sampleCount=l.X4)}function t(){return{enabled:!1,material:null,enableAlphaMask:!1,iterations:3,threshold:.8,intensity:2.3}}function o(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.enableAlphaMask&&(e.enableAlphaMask=!1),void 0===e.iterations&&(e.iterations=3),void 0===e.threshold&&(e.threshold=.8),void 0===e.intensity&&(e.intensity=2.3)}function d(){return{enabled:!1,material:null,contribute:1,colorGradingMap:null}}function u(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.contribute&&(e.contribute=1),void 0===e.colorGradingMap&&(e.colorGradingMap=null)}function s(){return{enabled:!1,material:null,sharpness:.8}}function c(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.sharpness&&(e.sharpness=.8)}function b(){return{enabled:!1,material:null}}function m(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null)}function p(){return{material:null}}function f(e){void 0===e.material&&(e.material=null)}a._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline.ts",["./rollupPluginModLoBabelHelpers.js","cc","./env","./builtin-pipeline-types.ts"],(function(e){var a,t,i,n,r,s,o,d,l,h,c,u,g,p,m,S,f,_,w,b,P;return{setters:[function(e){a=e.createClass,t=e.classCallCheck,i=e.defineProperty,n=e.createForOfIteratorHelper},function(e){r=e.cclegacy,s=e.geometry,o=e.gfx,d=e.renderer,l=e.rendering,h=e.Vec2,c=e.Vec4,u=e.Vec3,g=e.assert,p=e.clamp,m=e.Layers,S=e.PipelineEventType,f=e.sys,_=e.pipeline,w=e.Material},function(e){e.EDITOR,b=e.DEBUG},function(e){P=e.makePipelineSettings}],execute:function(){e("getPingPongRenderTarget",V),r._RF.push({},"ff9b0GZzgRM/obMbHGfCNbk","builtin-pipeline",void 0);var v=s.AABB,R=s.Sphere,T=s.intersect,M=o.ClearFlagBit,E=o.Color,C=o.Format,A=o.FormatFeatureBit,L=o.LoadOp,x=o.StoreOp,y=o.TextureType,D=o.Viewport,F=d.scene,N=F.CameraUsage,O=F.CSMLevel,B=F.LightType;function Q(e){return!!(e.clearFlag&(M.COLOR|M.STENCIL<<1))}function k(e,a,t,i,n,r){e.shadowFixedArea||e.csmLevel===O.LEVEL_1?(n.left=0,n.top=0,n.width=Math.trunc(a),n.height=Math.trunc(t)):(n.left=Math.trunc(i%2*.5*a),n.top=r>0?Math.trunc(.5*(1-Math.floor(i/2))*t):Math.trunc(.5*Math.floor(i/2)*t),n.width=Math.trunc(.5*a),n.height=Math.trunc(.5*t)),n.left=Math.max(0,n.left),n.top=Math.max(0,n.top),n.width=Math.max(1,n.width),n.height=Math.max(1,n.height)}var H=e("PipelineConfigs",a((function e(){t(this,e),i(this,"isWeb",!1),i(this,"isWebGL1",!1),i(this,"isWebGPU",!1),i(this,"isMobile",!1),i(this,"isHDR",!1),i(this,"useFloatOutput",!1),i(this,"toneMappingType",0),i(this,"shadowEnabled",!1),i(this,"shadowMapFormat",C.R32F),i(this,"shadowMapSize",new h(1,1)),i(this,"usePlanarShadow",!1),i(this,"screenSpaceSignY",1),i(this,"supportDepthSample",!1),i(this,"mobileMaxSpotLightShadowMaps",1),i(this,"platform",new c(0,0,0,0))})));function z(e,a){var t=A.SAMPLED_TEXTURE|A.LINEAR_FILTER,i=e.device;a.isWeb=!f.isNative,a.isWebGL1=i.gfxAPI===o.API.WEBGL,a.isWebGPU=i.gfxAPI===o.API.WEBGPU,a.isMobile=f.isMobile,a.isHDR=e.pipelineSceneData.isHDR,a.useFloatOutput=e.getMacroBool("CC_USE_FLOAT_OUTPUT"),a.toneMappingType=e.pipelineSceneData.postSettings.toneMappingType;var n=e.pipelineSceneData.shadows;a.shadowEnabled=n.enabled,a.shadowMapFormat=_.supportsR32FloatTexture(e.device)?C.R32F:C.RGBA8,a.shadowMapSize.set(n.size),a.usePlanarShadow=n.enabled&&n.type===d.scene.ShadowType.Planar,a.screenSpaceSignY=e.device.capabilities.screenSpaceSignY,a.supportDepthSample=(e.device.getFormatFeatures(C.DEPTH_STENCIL)&t)===t;var r=i.capabilities.screenSpaceSignY;a.platform.x=a.isMobile?1:0,a.platform.w=.5*r+.5<<1|.5*i.capabilities.clipSpaceSignY+.5}var I=P(),W=e("CameraConfigs",a((function e(){t(this,e),i(this,"settings",I),i(this,"isMainGameWindow",!1),i(this,"renderWindowId",0),i(this,"colorName",""),i(this,"depthStencilName",""),i(this,"enableFullPipeline",!1),i(this,"enableProfiler",!1),i(this,"remainingPasses",0),i(this,"enableShadingScale",!1),i(this,"shadingScale",1),i(this,"nativeWidth",1),i(this,"nativeHeight",1),i(this,"width",1),i(this,"height",1),i(this,"enableHDR",!1),i(this,"radianceFormat",o.Format.RGBA8),i(this,"copyAndTonemapMaterial",null),i(this,"enableStoreSceneDepth",!1)}))),G=new E(0,0,0,0);function U(e,a,t,i){g(!!t.copyAndTonemapMaterial);var n=e.addRenderPass(t.nativeWidth,t.nativeHeight,"cc-tone-mapping");return n.addRenderTarget(t.colorName,L.CLEAR,x.STORE,G),n.addTexture(i,"inputTexture"),n.setVec4("g_platform",a.platform),n.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,1),n}function V(e,a,t){return e.startsWith(a)?"".concat(a).concat(1-Number(e.charAt(a.length)),"_").concat(t):"".concat(a,"0_").concat(t)}var Y=function(){function e(){t(this,e),i(this,"lights",[]),i(this,"shadowEnabledSpotLights",[]),i(this,"_sphere",R.create(0,0,0,1)),i(this,"_boundingBox",new v),i(this,"_rangedDirLightBoundingBox",new v(0,0,0,.5,.5,.5))}return a(e,[{key:"cullLights",value:function(e,a,t){this.lights.length=0,this.shadowEnabledSpotLights.length=0;var i,r=n(e.spotLights);try{for(r.s();!(i=r.n()).done;){var s=i.value;s.baked||(R.set(this._sphere,s.position.x,s.position.y,s.position.z,s.range),T.sphereFrustum(this._sphere,a)&&(s.shadowEnabled?this.shadowEnabledSpotLights.push(s):this.lights.push(s)))}}catch(e){r.e(e)}finally{r.f()}var o,d=n(e.sphereLights);try{for(d.s();!(o=d.n()).done;){var l=o.value;l.baked||(R.set(this._sphere,l.position.x,l.position.y,l.position.z,l.range),T.sphereFrustum(this._sphere,a)&&this.lights.push(l))}}catch(e){d.e(e)}finally{d.f()}var h,c=n(e.pointLights);try{for(c.s();!(h=c.n()).done;){var g=h.value;g.baked||(R.set(this._sphere,g.position.x,g.position.y,g.position.z,g.range),T.sphereFrustum(this._sphere,a)&&this.lights.push(g))}}catch(e){c.e(e)}finally{c.f()}var p,m=n(e.rangedDirLights);try{for(m.s();!(p=m.n()).done;){var S=p.value;v.transform(this._boundingBox,this._rangedDirLightBoundingBox,S.node.getWorldMatrix()),T.aabbFrustum(this._boundingBox,a)&&this.lights.push(S)}}catch(e){m.e(e)}finally{m.f()}t&&this.shadowEnabledSpotLights.sort((function(e,a){return u.squaredDistance(t,e.position)-u.squaredDistance(t,a.position)}))}},{key:"_addLightQueues",value:function(e,a){var t,i=n(this.lights);try{for(i.s();!(t=i.n()).done;){var r=t.value,s=a.addQueue(l.QueueHint.BLEND,"forward-add");switch(r.type){case B.SPHERE:s.name="sphere-light";break;case B.SPOT:s.name="spot-light";break;case B.POINT:s.name="point-light";break;case B.RANGED_DIRECTIONAL:s.name="ranged-directional-light";break;default:s.name="unknown-light"}s.addScene(e,l.SceneFlags.BLEND,r)}}catch(e){i.e(e)}finally{i.f()}}},{key:"addSpotlightShadowPasses",value:function(e,a,t){var i,r=0,s=n(this.shadowEnabledSpotLights);try{for(s.s();!(i=s.n()).done;){var o=i.value,d=e.pipelineSceneData.shadows.size,h=e.addRenderPass(d.x,d.y,"default");if(h.name="SpotLightShadowPass".concat(r),h.addRenderTarget("SpotShadowMap".concat(r),L.CLEAR,x.STORE,new E(1,1,1,1)),h.addDepthStencil("SpotShadowDepth".concat(r),L.CLEAR,x.DISCARD),h.addQueue(l.QueueHint.NONE,"shadow-caster").addScene(a,l.SceneFlags.OPAQUE|l.SceneFlags.MASK|l.SceneFlags.SHADOW_CASTER).useLightFrustum(o),++r>=t)break}}catch(e){s.e(e)}finally{s.f()}}},{key:"addLightQueues",value:function(e,a,t){this._addLightQueues(a,e);var i,r=0,s=n(this.shadowEnabledSpotLights);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(e.addTexture("SpotShadowMap".concat(r),"cc_spotShadowMap"),e.addQueue(l.QueueHint.BLEND,"forward-add").addScene(a,l.SceneFlags.BLEND,o),++r>=t)break}}catch(e){s.e(e)}finally{s.f()}}},{key:"addLightPasses",value:function(e,a,t,i,r,s,o,d,h,c){this._addLightQueues(o,c);var u,g=0,p=h.pipelineSceneData.shadows.size,m=n(this.shadowEnabledSpotLights);try{for(m.s();!(u=m.n()).done;){var S=u.value,f=h.addRenderPass(p.x,p.y,"default");f.name="SpotlightShadowPass",f.addRenderTarget("ShadowMap".concat(i),L.CLEAR,x.STORE,new E(1,1,1,1)),f.addDepthStencil("ShadowDepth".concat(i),L.CLEAR,x.DISCARD),f.addQueue(l.QueueHint.NONE,"shadow-caster").addScene(o,l.SceneFlags.OPAQUE|l.SceneFlags.MASK|l.SceneFlags.SHADOW_CASTER).useLightFrustum(S);var _=++g===this.shadowEnabledSpotLights.length?t:x.STORE;(c=h.addRenderPass(r,s,"default")).name="SpotlightWithShadowMap",c.setViewport(d),c.addRenderTarget(e,L.LOAD),c.addDepthStencil(a,L.LOAD,_),c.addTexture("ShadowMap".concat(i),"cc_spotShadowMap"),c.addQueue(l.QueueHint.BLEND,"forward-add").addScene(o,l.SceneFlags.BLEND,S)}}catch(e){m.e(e)}finally{m.f()}return c}},{key:"isMultipleLightPassesNeeded",value:function(){return this.shadowEnabledSpotLights.length>0}}]),e}(),X=e("BuiltinForwardPassBuilder",function(){function e(){t(this,e),i(this,"forwardLighting",new Y),i(this,"_viewport",new D),i(this,"_clearColor",new E(0,0,0,1)),i(this,"_reflectionProbeClearColor",new u(0,0,0))}return a(e,[{key:"getConfigOrder",value:function(){return e.ConfigOrder}},{key:"getRenderOrder",value:function(){return e.RenderOrder}},{key:"configCamera",value:function(e,a,t){t.enableMainLightShadowMap=a.shadowEnabled&&!a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enableMainLightPlanarShadowMap=a.shadowEnabled&&a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enablePlanarReflectionProbe=t.isMainGameWindow||e.cameraUsage===N.SCENE_VIEW||e.cameraUsage===N.GAME_VIEW,t.enableMSAA=t.settings.msaa.enabled&&!t.enableStoreSceneDepth&&!a.isWeb&&!a.isWebGL1,t.enableSingleForwardPass=a.isMobile||t.enableMSAA,++t.remainingPasses}},{key:"windowResize",value:function(e,a,t,i,n,r,s){var o=l.ResourceFlags,d=l.ResourceResidency,h=i.renderWindowId,c=t.settings,u=t.enableShadingScale?Math.max(Math.floor(r*t.shadingScale),1):r,g=t.enableShadingScale?Math.max(Math.floor(s*t.shadingScale),1):s;if(t.enableMSAA&&(t.enableHDR?e.addTexture("MsaaRadiance".concat(h),y.TEX2D,t.radianceFormat,u,g,1,1,1,c.msaa.sampleCount,o.COLOR_ATTACHMENT,d.MEMORYLESS):e.addTexture("MsaaRadiance".concat(h),y.TEX2D,C.RGBA8,u,g,1,1,1,c.msaa.sampleCount,o.COLOR_ATTACHMENT,d.MEMORYLESS),e.addTexture("MsaaDepthStencil".concat(h),y.TEX2D,C.DEPTH_STENCIL,u,g,1,1,1,c.msaa.sampleCount,o.DEPTH_STENCIL_ATTACHMENT,d.MEMORYLESS)),e.addRenderTarget("ShadowMap".concat(h),a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("ShadowDepth".concat(h),C.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y),t.enableSingleForwardPass)for(var p=a.mobileMaxSpotLightShadowMaps,m=0;m!==p;++m)e.addRenderTarget("SpotShadowMap".concat(m),a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("SpotShadowDepth".concat(m),C.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y)}},{key:"setup",value:function(e,a,t,i,n){var r=i.window.renderWindowId,s=i.scene,o=s.mainLight;--t.remainingPasses,g(t.remainingPasses>=0),this.forwardLighting.cullLights(s,i.frustum),t.enableMainLightShadowMap&&(g(!!o),this._addCascadedShadowMapPass(e,a,r,o,i)),t.enableSingleForwardPass&&this.forwardLighting.addSpotlightShadowPasses(e,i,a.mobileMaxSpotLightShadowMaps),this._tryAddReflectionProbePasses(e,t,r,o,i.scene),t.remainingPasses>0||t.enableShadingScale?(n.colorName=t.enableShadingScale?"ScaledRadiance0_".concat(r):"Radiance0_".concat(r),n.depthStencilName=t.enableShadingScale?"ScaledSceneDepth_".concat(r):"SceneDepth_".concat(r)):(n.colorName=t.colorName,n.depthStencilName=t.depthStencilName);var d=this._addForwardRadiancePasses(e,a,t,r,i,t.width,t.height,o,n.colorName,n.depthStencilName,!t.enableMSAA,t.enableStoreSceneDepth?x.STORE:x.DISCARD);return t.enableStoreSceneDepth||(n.depthStencilName=""),0===t.remainingPasses&&t.enableShadingScale?U(e,a,t,n.colorName):d}},{key:"_addCascadedShadowMapPass",value:function(e,a,t,i,n){var r=l.QueueHint,s=l.SceneFlags,o=e.pipelineSceneData.shadows.size,d=o.x,h=o.y,c=this._viewport;c.left=c.top=0,c.width=d,c.height=h;var u=e.addRenderPass(d,h,"default");u.name="CascadedShadowMap",u.addRenderTarget("ShadowMap".concat(t),L.CLEAR,x.STORE,new E(1,1,1,1)),u.addDepthStencil("ShadowDepth".concat(t),L.CLEAR,x.DISCARD);for(var g=e.pipelineSceneData.csmSupported?i.csmLevel:1,p=0;p!==g;++p){k(i,d,h,p,this._viewport,a.screenSpaceSignY);var m=u.addQueue(r.NONE,"shadow-caster");a.isWebGPU||m.setViewport(this._viewport),m.addScene(n,s.OPAQUE|s.MASK|s.SHADOW_CASTER).useLightFrustum(i,p)}}},{key:"_tryAddReflectionProbePasses",value:function(e,a,t,i,s){var h=r.internal.reflectionProbeManager;if(h){var c,u=l.ResourceResidency,g=h.getProbes(),p=0,m=n(g);try{for(m.s();!(c=m.n()).done;){var S=c.value;if(S.needRender){var f=S.renderArea(),_=Math.max(Math.floor(f.x),1),w=Math.max(Math.floor(f.y),1);if(S.probeType===d.scene.ProbeType.PLANAR){if(!a.enablePlanarReflectionProbe)continue;var b=S.realtimePlanarTexture.window,P="PlanarProbeRT".concat(p),v="PlanarProbeDS".concat(p);e.addRenderWindow(P,a.radianceFormat,_,w,b),e.addDepthStencil(v,o.Format.DEPTH_STENCIL,_,w,u.MEMORYLESS);var R=e.addRenderPass(_,w,"default");R.name="PlanarReflectionProbe".concat(p),this._buildReflectionProbePass(R,a,t,S.camera,P,v,i,s)}else;if(4===++p)break}}}catch(e){m.e(e)}finally{m.f()}}}},{key:"_buildReflectionProbePass",value:function(e,a,t,i,n,r,s){var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,d=l.QueueHint,h=l.SceneFlags,c=a.enableMSAA?x.DISCARD:x.STORE;if(Q(i)){this._reflectionProbeClearColor.x=i.clearColor.x,this._reflectionProbeClearColor.y=i.clearColor.y,this._reflectionProbeClearColor.z=i.clearColor.z;var u=l.packRGBE(this._reflectionProbeClearColor);this._clearColor.x=u.x,this._clearColor.y=u.y,this._clearColor.z=u.z,this._clearColor.w=u.w,e.addRenderTarget(n,L.CLEAR,c,this._clearColor)}else e.addRenderTarget(n,L.LOAD,c);i.clearFlag&M.DEPTH_STENCIL?e.addDepthStencil(r,L.CLEAR,x.DISCARD,i.clearDepth,i.clearStencil,i.clearFlag&M.DEPTH_STENCIL):e.addDepthStencil(r,L.LOAD,x.DISCARD),a.enableMainLightShadowMap&&e.addTexture("ShadowMap".concat(t),"cc_shadowMap"),e.addQueue(d.NONE,"reflect-map").addScene(i,h.OPAQUE|h.MASK|h.REFLECTION_PROBE,s||void 0,o||void 0)}},{key:"_addForwardRadiancePasses",value:function(e,a,t,i,n,r,s,o,d,h){var c=arguments.length>10&&void 0!==arguments[10]&&arguments[10],u=arguments.length>11&&void 0!==arguments[11]?arguments[11]:x.DISCARD,p=l.QueueHint,m=l.SceneFlags,S=n.clearColor;this._clearColor.x=S.x,this._clearColor.y=S.y,this._clearColor.z=S.z,this._clearColor.w=S.w;var f=n.viewport;this._viewport.left=Math.round(f.x*r),this._viewport.top=Math.round(f.y*s),this._viewport.width=Math.max(Math.round(f.width*r),1),this._viewport.height=Math.max(Math.round(f.height*s),1);var _=!c&&t.enableMSAA;g(!_||t.enableSingleForwardPass);var w=t.enableSingleForwardPass?this._addForwardSingleRadiancePass(e,a,t,i,n,_,r,s,o,d,h,u):this._addForwardMultipleRadiancePasses(e,t,i,n,r,s,o,d,h,u);t.enableMainLightPlanarShadowMap&&this._addPlanarShadowQueue(n,o,w);var b=m.BLEND|(n.geometryRenderer?m.GEOMETRY:m.NONE);return w.addQueue(p.BLEND).addScene(n,b,o||void 0),w}},{key:"_addForwardSingleRadiancePass",value:function(e,a,t,i,n,r,s,o,d,l,h,c){var u;if(g(t.enableSingleForwardPass),r){var p="MsaaRadiance".concat(i),m="MsaaDepthStencil".concat(i),S=t.settings.msaa.sampleCount,f=e.addMultisampleRenderPass(s,o,S,0,"default");f.name="MsaaForwardPass",this._buildForwardMainLightPass(f,t,i,n,p,m,x.DISCARD,d),f.resolveRenderTarget(p,l),u=f}else(u=e.addRenderPass(s,o,"default")).name="ForwardPass",this._buildForwardMainLightPass(u,t,i,n,l,h,c,d);return g(void 0!==u),this.forwardLighting.addLightQueues(u,n,a.mobileMaxSpotLightShadowMaps),u}},{key:"_addForwardMultipleRadiancePasses",value:function(e,a,t,i,n,r,s,o,d,l){g(!a.enableSingleForwardPass);var h=e.addRenderPass(n,r,"default");h.name="ForwardPass";var c=this.forwardLighting.isMultipleLightPassesNeeded()?x.STORE:l;return this._buildForwardMainLightPass(h,a,t,i,o,d,c,s),h=this.forwardLighting.addLightPasses(o,d,l,t,n,r,i,this._viewport,e,h)}},{key:"_buildForwardMainLightPass",value:function(e,a,t,i,n,r,s,o){var d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,h=l.QueueHint,c=l.SceneFlags;e.setViewport(this._viewport);var u=a.enableMSAA?x.DISCARD:x.STORE;Q(i)?e.addRenderTarget(n,L.CLEAR,u,this._clearColor):e.addRenderTarget(n,L.LOAD,u),i.clearFlag&M.DEPTH_STENCIL?e.addDepthStencil(r,L.CLEAR,s,i.clearDepth,i.clearStencil,i.clearFlag&M.DEPTH_STENCIL):e.addDepthStencil(r,L.LOAD,s),a.enableMainLightShadowMap&&e.addTexture("ShadowMap".concat(t),"cc_shadowMap"),e.addQueue(h.NONE).addScene(i,c.OPAQUE|c.MASK,o||void 0,d||void 0)}},{key:"_addPlanarShadowQueue",value:function(e,a,t){var i=l.QueueHint,n=l.SceneFlags;t.addQueue(i.BLEND,"planar-shadow").addScene(e,n.SHADOW_CASTER|n.PLANAR_SHADOW|n.BLEND,a||void 0)}}]),e}());i(X,"ConfigOrder",100),i(X,"RenderOrder",100);var K=e("BuiltinBloomPassBuilder",function(){function e(){t(this,e),i(this,"_clearColorTransparentBlack",new E(0,0,0,0)),i(this,"_bloomParams",new c(0,0,0,0)),i(this,"_bloomTexSize",new c(0,0,0,0)),i(this,"_bloomWidths",[]),i(this,"_bloomHeights",[]),i(this,"_bloomTexNames",[])}return a(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 200}},{key:"configCamera",value:function(e,a,t){t.enableBloom=t.settings.bloom.enabled&&!!t.settings.bloom.material,t.enableBloom&&++t.remainingPasses}},{key:"windowResize",value:function(e,a,t,i){if(t.enableBloom)for(var n=i.renderWindowId,r=t.width,s=t.height,o=0;o!==t.settings.bloom.iterations+1;++o)r=Math.max(Math.floor(r/2),1),s=Math.max(Math.floor(s/2),1),e.addRenderTarget("BloomTex".concat(n,"_").concat(o),t.radianceFormat,r,s)}},{key:"setup",value:function(e,a,t,i,n,r){if(!t.enableBloom)return r;--t.remainingPasses,g(t.remainingPasses>=0);var s=i.window.renderWindowId;return g(!!t.settings.bloom.material),this._addKawaseDualFilterBloomPasses(e,a,t,t.settings,t.settings.bloom.material,s,t.width,t.height,n.colorName)}},{key:"_addKawaseDualFilterBloomPasses",value:function(e,a,t,i,n,r,s,o,d){var h=l.QueueHint,c=i.bloom.iterations,u=c+1;this._bloomWidths.length=u,this._bloomHeights.length=u,this._bloomWidths[0]=Math.max(Math.floor(s/2),1),this._bloomHeights[0]=Math.max(Math.floor(o/2),1);for(var g=1;g!==u;++g)this._bloomWidths[g]=Math.max(Math.floor(this._bloomWidths[g-1]/2),1),this._bloomHeights[g]=Math.max(Math.floor(this._bloomHeights[g-1]/2),1);this._bloomTexNames.length=u;for(var p=0;p!==u;++p)this._bloomTexNames[p]="BloomTex".concat(r,"_").concat(p);this._bloomParams.x=a.useFloatOutput?1:0,this._bloomParams.x=0,this._bloomParams.z=i.bloom.threshold,this._bloomParams.w=i.bloom.enableAlphaMask?1:0;var m=e.addRenderPass(this._bloomWidths[0],this._bloomHeights[0],"cc-bloom-prefilter");m.addRenderTarget(this._bloomTexNames[0],L.CLEAR,x.STORE,this._clearColorTransparentBlack),m.addTexture(d,"inputTexture"),m.setVec4("g_platform",a.platform),m.setVec4("bloomParams",this._bloomParams),m.addQueue(h.OPAQUE).addFullscreenQuad(n,0);for(var S=1;S!==u;++S){var f=e.addRenderPass(this._bloomWidths[S],this._bloomHeights[S],"cc-bloom-downsample");f.addRenderTarget(this._bloomTexNames[S],L.CLEAR,x.STORE,this._clearColorTransparentBlack),f.addTexture(this._bloomTexNames[S-1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[S-1],this._bloomTexSize.y=this._bloomHeights[S-1],f.setVec4("g_platform",a.platform),f.setVec4("bloomTexSize",this._bloomTexSize),f.addQueue(h.OPAQUE).addFullscreenQuad(n,1)}for(var _=c;_-- >0;){var w=e.addRenderPass(this._bloomWidths[_],this._bloomHeights[_],"cc-bloom-upsample");w.addRenderTarget(this._bloomTexNames[_],L.CLEAR,x.STORE,this._clearColorTransparentBlack),w.addTexture(this._bloomTexNames[_+1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[_+1],this._bloomTexSize.y=this._bloomHeights[_+1],w.setVec4("g_platform",a.platform),w.setVec4("bloomTexSize",this._bloomTexSize),w.addQueue(h.OPAQUE).addFullscreenQuad(n,2)}var b=e.addRenderPass(s,o,"cc-bloom-combine");return b.addRenderTarget(d,L.LOAD,x.STORE),b.addTexture(this._bloomTexNames[0],"bloomTexture"),b.setVec4("g_platform",a.platform),b.setVec4("bloomParams",this._bloomParams),b.addQueue(h.BLEND).addFullscreenQuad(n,3),0===t.remainingPasses?U(e,a,t,d):b}}]),e}()),q=e("BuiltinToneMappingPassBuilder",function(){function e(){t(this,e),i(this,"_colorGradingTexSize",new h(0,0))}return a(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 300}},{key:"configCamera",value:function(e,a,t){var i=t.settings;t.enableColorGrading=i.colorGrading.enabled&&!!i.colorGrading.material&&!!i.colorGrading.colorGradingMap,t.enableToneMapping=t.enableHDR||t.enableColorGrading,t.enableToneMapping&&++t.remainingPasses}},{key:"windowResize",value:function(e,a,t){t.enableColorGrading&&(g(!!t.settings.colorGrading.material),t.settings.colorGrading.material.setProperty("colorGradingMap",t.settings.colorGrading.colorGradingMap))}},{key:"setup",value:function(e,a,t,i,n,r){if(!t.enableToneMapping)return r;if(--t.remainingPasses,g(t.remainingPasses>=0),0===t.remainingPasses)return this._addCopyAndTonemapPass(e,a,t,t.width,t.height,n.colorName,t.colorName);var s=t.renderWindowId,o=t.enableShadingScale?"ScaledLdrColor":"LdrColor",d=V(n.colorName,o,s),l=n.colorName;return n.colorName=d,this._addCopyAndTonemapPass(e,a,t,t.width,t.height,l,d)}},{key:"_addCopyAndTonemapPass",value:function(e,a,t,i,n,r,s){var o,d=t.settings;if(t.enableColorGrading){g(!!d.colorGrading.material),g(!!d.colorGrading.colorGradingMap);var h=d.colorGrading.colorGradingMap;this._colorGradingTexSize.x=h.width,this._colorGradingTexSize.y=h.height;var c=h.width===h.height;(o=c?e.addRenderPass(i,n,"cc-color-grading-8x8"):e.addRenderPass(i,n,"cc-color-grading-nx1")).addRenderTarget(s,L.CLEAR,x.STORE,G),o.addTexture(r,"sceneColorMap"),o.setVec4("g_platform",a.platform),o.setVec2("lutTextureSize",this._colorGradingTexSize),o.setFloat("contribute",d.colorGrading.contribute),o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(d.colorGrading.material,c?1:0)}else(o=e.addRenderPass(i,n,"cc-tone-mapping")).addRenderTarget(s,L.CLEAR,x.STORE,G),o.addTexture(r,"inputTexture"),o.setVec4("g_platform",a.platform),d.toneMapping.material?o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(d.toneMapping.material,0):(g(!!t.copyAndTonemapMaterial),o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,0));return o}}]),e}()),j=e("BuiltinFXAAPassBuilder",function(){function e(){t(this,e),i(this,"_fxaaParams",new c(0,0,0,0))}return a(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 400}},{key:"configCamera",value:function(e,a,t){t.enableFXAA=t.settings.fxaa.enabled&&!!t.settings.fxaa.material,t.enableFXAA&&++t.remainingPasses}},{key:"setup",value:function(e,a,t,i,n,r){if(!t.enableFXAA)return r;--t.remainingPasses,g(t.remainingPasses>=0);var s=t.renderWindowId,o=t.enableShadingScale?"ScaledLdrColor":"LdrColor",d=V(n.colorName,o,s);if(g(!!t.settings.fxaa.material),0===t.remainingPasses)return t.enableShadingScale?(this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,n.colorName,d),U(e,a,t,d)):(g(t.width===t.nativeWidth),g(t.height===t.nativeHeight),this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,n.colorName,t.colorName));var l=n.colorName;return n.colorName=d,this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,l,d)}},{key:"_addFxaaPass",value:function(e,a,t,i,n,r,s){this._fxaaParams.x=i,this._fxaaParams.y=n,this._fxaaParams.z=1/i,this._fxaaParams.w=1/n;var o=e.addRenderPass(i,n,"cc-fxaa");return o.addRenderTarget(s,L.CLEAR,x.STORE,G),o.addTexture(r,"sceneColorMap"),o.setVec4("g_platform",a.platform),o.setVec4("texSize",this._fxaaParams),o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(t,0),o}}]),e}()),Z=e("BuiltinFsrPassBuilder",function(){function e(){t(this,e),i(this,"_fsrParams",new c(0,0,0,0)),i(this,"_fsrTexSize",new c(0,0,0,0))}return a(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 500}},{key:"configCamera",value:function(e,a,t){t.enableFSR=t.settings.fsr.enabled&&!!t.settings.fsr.material&&t.enableShadingScale&&t.shadingScale<1,t.enableFSR&&++t.remainingPasses}},{key:"setup",value:function(e,a,t,i,n,r){if(!t.enableFSR)return r;--t.remainingPasses;var s=n.colorName,o=0===t.remainingPasses?t.colorName:V(n.colorName,"UiColor",t.renderWindowId);return n.colorName=o,g(!!t.settings.fsr.material),this._addFsrPass(e,a,t,t.settings,t.settings.fsr.material,t.renderWindowId,t.width,t.height,s,t.nativeWidth,t.nativeHeight,o)}},{key:"_addFsrPass",value:function(e,a,t,i,n,r,s,o,d,h,c,u){this._fsrTexSize.x=s,this._fsrTexSize.y=o,this._fsrTexSize.z=h,this._fsrTexSize.w=c,this._fsrParams.x=p(1-i.fsr.sharpness,.02,.98);var g=V(u,"UiColor",r),m=e.addRenderPass(h,c,"cc-fsr-easu");m.addRenderTarget(g,L.CLEAR,x.STORE,G),m.addTexture(d,"outputResultMap"),m.setVec4("g_platform",a.platform),m.setVec4("fsrTexSize",this._fsrTexSize),m.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(n,0);var S=e.addRenderPass(h,c,"cc-fsr-rcas");return S.addRenderTarget(u,L.CLEAR,x.STORE,G),S.addTexture(g,"outputResultMap"),S.setVec4("g_platform",a.platform),S.setVec4("fsrTexSize",this._fsrTexSize),S.setVec4("fsrParams",this._fsrParams),S.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(n,1),S}}]),e}()),J=e("BuiltinUiPassBuilder",function(){function e(){t(this,e)}return a(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 1e3}},{key:"setup",value:function(e,a,t,i,n,r){g(!!r);var s=l.SceneFlags.UI;return t.enableProfiler&&(s|=l.SceneFlags.PROFILER,r.showStatistics=!0),r.addQueue(l.QueueHint.BLEND,"default","default").addScene(i,s),r}}]),e}());if(l){var $=l.QueueHint,ee=l.SceneFlags,ae=function(){function e(){t(this,e),i(this,"_pipelineEvent",r.director.root.pipelineEvent),i(this,"_forwardPass",new X),i(this,"_bloomPass",new K),i(this,"_toneMappingPass",new q),i(this,"_fxaaPass",new j),i(this,"_fsrPass",new Z),i(this,"_uiPass",new J),i(this,"_clearColor",new E(0,0,0,1)),i(this,"_viewport",new D),i(this,"_configs",new H),i(this,"_cameraConfigs",new W),i(this,"_copyAndTonemapMaterial",new w),i(this,"_initialized",!1),i(this,"_passBuilders",[])}return a(e,[{key:"_setupPipelinePreview",value:function(e,a){if(e.cameraUsage===N.SCENE_VIEW||e.cameraUsage===N.PREVIEW){var t=l.getEditorPipelineSettings();a.settings=t||I}else e.pipelineSettings?a.settings=e.pipelineSettings:a.settings=I}},{key:"_preparePipelinePasses",value:function(e){var a=this._passBuilders;a.length=0;var t=e.settings;if(t._passes){var i,r=n(t._passes);try{for(r.s();!(i=r.n()).done;){var s=i.value;a.push(s)}}catch(e){r.e(e)}finally{r.f()}g(a.length===t._passes.length)}a.push(this._forwardPass),t.bloom.enabled&&a.push(this._bloomPass),a.push(this._toneMappingPass),t.fxaa.enabled&&a.push(this._fxaaPass),t.fsr.enabled&&a.push(this._fsrPass),a.push(this._uiPass)}},{key:"_setupBuiltinCameraConfigs",value:function(e,a,t){var i=e.window,n=e.cameraUsage===N.GAME&&!!i.swapchain;t.isMainGameWindow=n,t.renderWindowId=i.renderWindowId,t.colorName=i.colorName,t.depthStencilName=i.depthStencilName,t.enableFullPipeline=0!=(e.visibility&m.Enum.DEFAULT),t.enableProfiler=b,t.remainingPasses=0,t.shadingScale=t.settings.shadingScale,t.enableShadingScale=t.settings.enableShadingScale&&1!==t.shadingScale,t.nativeWidth=Math.max(Math.floor(i.width),1),t.nativeHeight=Math.max(Math.floor(i.height),1),t.width=t.enableShadingScale?Math.max(Math.floor(t.nativeWidth*t.shadingScale),1):t.nativeWidth,t.height=t.enableShadingScale?Math.max(Math.floor(t.nativeHeight*t.shadingScale),1):t.nativeHeight,t.enableHDR=t.enableFullPipeline&&a.useFloatOutput,t.radianceFormat=t.enableHDR?o.Format.RGBA16F:o.Format.RGBA8,t.copyAndTonemapMaterial=this._copyAndTonemapMaterial,t.enableStoreSceneDepth=!1}},{key:"_setupCameraConfigs",value:function(e,a,t){this._setupPipelinePreview(e,t),this._preparePipelinePasses(t),this._passBuilders.sort((function(e,a){return e.getConfigOrder()-a.getConfigOrder()})),this._setupBuiltinCameraConfigs(e,a,t);var i,r=n(this._passBuilders);try{for(r.s();!(i=r.n()).done;){var s=i.value;s.configCamera&&s.configCamera(e,a,t)}}catch(e){r.e(e)}finally{r.f()}}},{key:"windowResize",value:function(e,a,t,i,r){z(e,this._configs),this._setupCameraConfigs(t,this._configs,this._cameraConfigs);var s=a.renderWindowId;e.addRenderWindow(this._cameraConfigs.colorName,C.RGBA8,i,r,a,this._cameraConfigs.depthStencilName);var o=this._cameraConfigs.width,d=this._cameraConfigs.height;this._cameraConfigs.enableShadingScale?(e.addDepthStencil("ScaledSceneDepth_".concat(s),C.DEPTH_STENCIL,o,d),e.addRenderTarget("ScaledRadiance0_".concat(s),this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("ScaledRadiance1_".concat(s),this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("ScaledLdrColor0_".concat(s),C.RGBA8,o,d),e.addRenderTarget("ScaledLdrColor1_".concat(s),C.RGBA8,o,d)):(e.addDepthStencil("SceneDepth_".concat(s),C.DEPTH_STENCIL,o,d),e.addRenderTarget("Radiance0_".concat(s),this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("Radiance1_".concat(s),this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("LdrColor0_".concat(s),C.RGBA8,o,d),e.addRenderTarget("LdrColor1_".concat(s),C.RGBA8,o,d)),e.addRenderTarget("UiColor0_".concat(s),C.RGBA8,i,r),e.addRenderTarget("UiColor1_".concat(s),C.RGBA8,i,r);var l,h=n(this._passBuilders);try{for(h.s();!(l=h.n()).done;){var c=l.value;c.windowResize&&c.windowResize(e,this._configs,this._cameraConfigs,a,t,i,r)}}catch(e){h.e(e)}finally{h.f()}}},{key:"setup",value:function(e,a){if(!this._initMaterials(a)){var t,i=n(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;r.scene&&r.window&&(this._setupCameraConfigs(r,this._configs,this._cameraConfigs),this._pipelineEvent.emit(S.RENDER_CAMERA_BEGIN,r),this._cameraConfigs.enableFullPipeline?this._buildForwardPipeline(a,r,r.scene,this._passBuilders):this._buildSimplePipeline(a,r),this._pipelineEvent.emit(S.RENDER_CAMERA_END,r))}}catch(e){i.e(e)}finally{i.f()}}}},{key:"_buildSimplePipeline",value:function(e,a){var t=Math.max(Math.floor(a.window.width),1),i=Math.max(Math.floor(a.window.height),1),n=this._cameraConfigs.colorName,r=this._cameraConfigs.depthStencilName,s=a.viewport;this._viewport.left=Math.round(s.x*t),this._viewport.top=Math.round(s.y*i),this._viewport.width=Math.max(Math.round(s.width*t),1),this._viewport.height=Math.max(Math.round(s.height*i),1);var o=a.clearColor;this._clearColor.x=o.x,this._clearColor.y=o.y,this._clearColor.z=o.z,this._clearColor.w=o.w;var d=e.addRenderPass(t,i,"default");Q(a)?d.addRenderTarget(n,L.CLEAR,x.STORE,this._clearColor):d.addRenderTarget(n,L.LOAD,x.STORE),a.clearFlag&M.DEPTH_STENCIL?d.addDepthStencil(r,L.CLEAR,x.DISCARD,a.clearDepth,a.clearStencil,a.clearFlag&M.DEPTH_STENCIL):d.addDepthStencil(r,L.LOAD,x.DISCARD),d.setViewport(this._viewport),d.addQueue($.OPAQUE).addScene(a,ee.OPAQUE);var l=ee.BLEND|ee.UI;this._cameraConfigs.enableProfiler&&(l|=ee.PROFILER,d.showStatistics=!0),d.addQueue($.BLEND).addScene(a,l)}},{key:"_buildForwardPipeline",value:function(e,a,t,i){!function(e){e.sort((function(e,a){return e.getRenderOrder()-a.getRenderOrder()}))}(i);var r,s={colorName:"",depthStencilName:""},o=void 0,d=n(i);try{for(d.s();!(r=d.n()).done;){var l=r.value;l.setup&&(o=l.setup(e,this._configs,this._cameraConfigs,a,s,o))}}catch(e){d.e(e)}finally{d.f()}g(0===this._cameraConfigs.remainingPasses)}},{key:"_initMaterials",value:function(e){return this._initialized?0:(z(e,this._configs),this._copyAndTonemapMaterial._uuid="builtin-pipeline-tone-mapping-material",this._copyAndTonemapMaterial.initialize({effectName:"pipeline/post-process/tone-mapping"}),this._copyAndTonemapMaterial.effectAsset&&(this._initialized=!0),this._initialized?0:1)}}]),e}();l.setCustomPipeline("Builtin",new ae)}r._RF.pop()}}}));

System.register("chunks:///_virtual/internal",["./builtin-pipeline-settings.ts","./builtin-pipeline-types.ts","./builtin-pipeline.ts"],(function(){return{setters:[null,null,null],execute:function(){}}}));

(function(r) {
  r('virtual:///prerequisite-imports/internal', 'chunks:///_virtual/internal'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});